---
title: "Relatório Semanal"
subtitle: "Análise e Insights do Monitoramento de Servidores"
author: "Equipe de AD - ServGuard"
date: "`r Sys.Date()`"
output: 
  html_document:
    #theme: cerulean
    toc: true
    toc_float: true
    color: black
color: black
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(DBI)
library(RMySQL)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(knitr)

```

# **Introdução**
#### Este relatório apresenta uma análise detalhada do desempenho dos recursos monitorados e alertas registrados nos últimos sete dias. Através dos dados capturados, destacam-se as tendências de uso de recursos, estabilidade de rede e os recursos mais problemáticos, fornecendo insights importantes para o monitoramento.

```{r echo=FALSE}

#Pacote:
  requireNamespace("DBI", quietly = TRUE)
  requireNamespace("RMySQL", quietly = TRUE)
  
  conexao <- dbConnect(RMySQL::MySQL(),
                       dbname = "ServGuard",#Nome do banco de dados
                       host = "127.0.0.1",#IP público da instância
                       port = 3306, 
                       user = "root",
                       password = "urubu100")
  
  #Variavel com o select do banco:
  select <- "SELECT * FROM vista_capturas_relatorio_semanal  WHERE idEmpresa = 1;"
  
  #Chamar o select e transformar os dado recebidos em uma variavel:
  dadosCaptura <- dbGetQuery(conexao,select)
  dadosCaptura$dthCriacao <- as.Date(dadosCaptura$dthCriacao)
  
```

# **Análise de Uso de Recursos**
#### A partir dos dados de uso de **CPU**, **RAM** e **uso geral**, foram gerados histogramas para identificar padrões de comportamento nas máquinas monitoradas.

```{r pressure_hist, echo=FALSE}

#HISTOGRAMA DE USO GERAL
#======================================================================================================

ggplot(dadosCaptura %>% filter(idRecurso == 3), aes(x = registro)) +
  geom_histogram(
    breaks = seq(0, 100, by = 10),
    fill = "#4E2E9E",
    color = "black",
    alpha = 0.8
  ) +
  labs(
    title = "Histograma de Uso Geral de Máquinas",
    x = "Faixas de uso (%)",
    y = "Frequência"
  ) +
  theme_minimal()


#HISTOGRAMA DE USO CPU
#======================================================================================================

ggplot(dadosCaptura %>% filter(idRecurso == 1), aes(x = registro)) +
  geom_histogram(
    breaks = seq(0, 100, by = 10),
    fill = "#767576",
    color = "black",
    alpha = 0.8
  ) +
  labs(
    title = "Histograma de Uso de CPU",
    x = "Faixas de uso (%)",
    y = "Frequência"
  ) +
  theme_minimal()

#HISTOGRAMA DE USO RAM
#======================================================================================================

ggplot(dadosCaptura %>% filter(idRecurso == 2), aes(x = registro)) +
  geom_histogram(
    breaks = seq(0, 100, by = 10),
    fill = "#767576",
    color = "black",
    alpha = 0.8
  ) +
  labs(
    title = "Histograma de Uso de RAM",
    x = "Faixas de uso (%)",
    y = "Frequência"
  ) +
  theme_minimal()

#TOP 5 MAQUINAS + E - USADAS
#======================================================================================================

media_usogeral_maquina <- dadosCaptura %>%
  filter(idRecurso == 3) %>%
  group_by(idMaquina) %>%
  summarise(mediaUso = mean(registro, na.rm = TRUE)) %>%
  arrange(desc(mediaUso))

top_5_mais_usadas <- media_usogeral_maquina %>%
  slice_max(order_by = mediaUso, n = 5)

top_5_menos_usadas <- media_usogeral_maquina %>%
  slice_min(order_by = mediaUso, n = 5)

kable(top_5_mais_usadas, caption = "Top 5 Máquinas Mais Utilizadas") %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover", "condensed"))

kable(top_5_menos_usadas, caption = "Top 5 Máquinas Menos Utilizadas") %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover", "condensed"))

```



# **Análise de Rede**

#### No monitoramento de Rede podemos observar sua estabilidade e desempenho.

```{r pressure_rede, echo=FALSE}

# CALCULO DE PERDA DE PACOTES
#======================================================================================================
dadosRede <- dadosCaptura %>%
  group_by(dthCriacao) %>%
  summarize(
    erro_pacotes_entrada = sum(registro[idRecurso == 6]),
    erro_pacotes_saida = sum(registro[idRecurso == 7]),
    descarte_pacotes_entrada = sum(registro[idRecurso == 8]),
    descarte_pacotes_saida = sum(registro[idRecurso == 9]),
    pacotes_enviados = sum(registro[idRecurso == 12]),
    pacotes_recebidos = sum(registro[idRecurso == 13]),
    pacotes_perdidos = erro_pacotes_entrada + erro_pacotes_saida + descarte_pacotes_entrada + descarte_pacotes_saida,
    pacotes_recebidos_totais = pacotes_recebidos + pacotes_enviados + pacotes_perdidos,
    taxa_perda_pacotes = (pacotes_perdidos / pacotes_recebidos_totais) * 100
  )

#GRAFICO DE LINHA
ggplot(dadosRede, aes(x = dthCriacao, y = taxa_perda_pacotes)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "red", size = 2) +
  labs(
    title = "Taxa de Perda de Pacotes por Dia",
    x = "Data",
    y = "Taxa de Perda (%)"
  ) +
  theme_minimal() +
  scale_x_date(date_labels = "%d/%m", date_breaks = "1 day")

#MEDIA DE DOWNLOAD E UPLOAD
#======================================================================================================

m_download <- mean(dadosCaptura$registro[dadosCaptura$idRecurso == 4])
m_upload <- mean(dadosCaptura$registro[dadosCaptura$idRecurso == 5])

#TAMANHO MEDIO PACOTES
#======================================================================================================

pacotes_R <- mean(dadosCaptura$registro[dadosCaptura$idRecurso == 13])
pacotes_E <- mean(dadosCaptura$registro[dadosCaptura$idRecurso == 12])
megabyte_R <- mean(dadosCaptura$registro[dadosCaptura$idRecurso == 10])
megabyte_E  <- mean(dadosCaptura$registro[dadosCaptura$idRecurso == 11])

tamanhoMedioPacote <- ((megabyte_E + megabyte_R) * 1024) / (pacotes_E + pacotes_R)
tamanhoMedioPacote_E <- (megabyte_E * 1024) / pacotes_E
tamanhoMedioPacote_R <- (megabyte_R * 1024) / pacotes_R

```

#### **Média de Download: `r m_download`Mb **
#### **Média de Upload: `r m_upload`Mb **

#### **Tamanho médio de pacotes: `r tamanhoMedioPacote`Kb**

# **Análise de Alerta**

#### Mediante aos últimos sete dias, foram identificados padrões e tendências nos alertas.

```{r pressure_alert, echo=FALSE}
#Pacote:
  requireNamespace("DBI", quietly = TRUE)
  library(DBI)
  requireNamespace("RMySQL", quietly = TRUE)
  library(RMySQL)
  library(knitr)
  library(dplyr)
  library(ggplot2)
  
qtdAlertas_dia <- dadosCaptura %>%
group_by(dthCriacao) %>%
summarise(qtdAlertas = sum(isAlerta))

#"id" do dia para fazer a regressao
qtdAlertas_dia <- qtdAlertas_dia %>%
  mutate(dias = as.integer(dthCriacao - min(dthCriacao)))

mediaAlertas_dia <- mean(qtdAlertas_dia$qtdAlertas)
totalAlertas <- sum(qtdAlertas_dia$qtdAlertas)

  
#GRAFICO PREVISAO DE TENDENCIA
#pegar P e R !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#======================================================================================================
ggplot(qtdAlertas_dia, aes(x = dias, y = qtdAlertas)) +
  geom_line(color = "blue") +
  geom_point(color = "red") +
  geom_smooth(method = "lm", color = "green") +
  labs(
    title = "Previsão de Tendência de Alertas",
    x = "Dias",
    y = "Quantidade de Alertas"
  ) +
  theme_minimal()

```

### **Resumo de Alertas**
#### Média de quantidade de alertas por dia: **`r mediaAlertas_dia`**
#### Quantidade de alertas na semana: **`r totalAlertas`**


### **Ranking de Recursos mais problemáticos:**

```{r pressure_alert2, echo=FALSE}

#RANKING DE RECURSO
#======================================================================================================
df_recursos <- dadosCaptura %>%
  group_by(idRecurso) %>%
  summarise(
    qtdAlertas = sum(isAlerta == 1)  
  )

df_recursos$idRecurso[df_recursos$idRecurso == 1] <- "CPU"
df_recursos$idRecurso[df_recursos$idRecurso == 2] <- "RAM"
df_recursos$idRecurso[df_recursos$idRecurso == 3] <- "Uso Geral"
df_recursos$idRecurso[df_recursos$idRecurso == 4] <- "Velocidade de Download"
df_recursos$idRecurso[df_recursos$idRecurso == 5] <- "Velocidade de Upload"
df_recursos$idRecurso[df_recursos$idRecurso == 6] <- "Erro de Pacotes de Entrada"
df_recursos$idRecurso[df_recursos$idRecurso == 7] <- "Erro de Pacotes de Saída"
df_recursos$idRecurso[df_recursos$idRecurso == 8] <- "Descarte de Pacotes de Entrada"
df_recursos$idRecurso[df_recursos$idRecurso == 9] <- "Descarte de Pacotes de Saída"
df_recursos$idRecurso[df_recursos$idRecurso == 10] <- "Megabytes Recebidos"
df_recursos$idRecurso[df_recursos$idRecurso == 11] <- "Megabytes Enviados"
df_recursos$idRecurso[df_recursos$idRecurso == 12] <- "Pacotes Enviados"
df_recursos$idRecurso[df_recursos$idRecurso == 13] <- "Pacotes Recebidos"

colnames(df_recursos) <- c("Nome do Recurso", "Quantidade de Alertas")
coluna <- "Quantidade de Alertas"
ranking <- df_recursos %>%
  slice_max(order_by = !!sym(coluna), n = 14)

kable(ranking)%>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover", "condensed"))

```




